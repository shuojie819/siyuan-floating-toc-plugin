"use strict";var ce=Object.defineProperty;var ae=(e,o,t)=>o in e?ce(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t;var B=(e,o,t)=>ae(e,typeof o!="symbol"?o+"":o,t);const de=require("siyuan");function et(){}function Rt(e){return e()}function Tt(){return Object.create(null)}function $(e){e.forEach(Rt)}function Ot(e){return typeof e=="function"}function ue(e,o){return e!=e?o==o:e!==o||e&&typeof e=="object"||typeof e=="function"}function he(e){return Object.keys(e).length===0}function T(e,o){e.appendChild(o)}function N(e,o,t){e.insertBefore(o,t||null)}function O(e){e.parentNode&&e.parentNode.removeChild(e)}function Mt(e,o){for(let t=0;t<e.length;t+=1)e[t]&&e[t].d(o)}function A(e){return document.createElement(e)}function rt(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function ct(e){return document.createTextNode(e)}function U(){return ct(" ")}function Nt(){return ct("")}function V(e,o,t,s){return e.addEventListener(o,t,s),()=>e.removeEventListener(o,t,s)}function ot(e){return function(o){return o.stopPropagation(),e.call(this,o)}}function h(e,o,t){t==null?e.removeAttribute(o):e.getAttribute(o)!==t&&e.setAttribute(o,t)}function fe(e){return Array.from(e.childNodes)}function Bt(e,o){o=""+o,e.data!==o&&(e.data=o)}function St(e,o,t,s){t==null?e.style.removeProperty(o):e.style.setProperty(o,t,"")}function z(e,o,t){e.classList.toggle(o,!!t)}let st;function tt(e){st=e}function mt(){if(!st)throw new Error("Function called outside component initialization");return st}function ge(e){mt().$$.on_mount.push(e)}function ye(e){mt().$$.after_update.push(e)}function pe(e){mt().$$.on_destroy.push(e)}const X=[],yt=[];let G=[];const Ct=[],be=Promise.resolve();let pt=!1;function me(){pt||(pt=!0,be.then(zt))}function bt(e){G.push(e)}const gt=new Set;let Z=0;function zt(){if(Z!==0)return;const e=st;do{try{for(;Z<X.length;){const o=X[Z];Z++,tt(o),_e(o.$$)}}catch(o){throw X.length=0,Z=0,o}for(tt(null),X.length=0,Z=0;yt.length;)yt.pop()();for(let o=0;o<G.length;o+=1){const t=G[o];gt.has(t)||(gt.add(t),t())}G.length=0}while(X.length);for(;Ct.length;)Ct.pop()();pt=!1,gt.clear(),tt(e)}function _e(e){if(e.fragment!==null){e.update(),$(e.before_update);const o=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,o),e.after_update.forEach(bt)}}function ve(e){const o=[],t=[];G.forEach(s=>e.indexOf(s)===-1?o.push(s):t.push(s)),t.forEach(s=>s()),G=o}const we=new Set;function ke(e,o){e&&e.i&&(we.delete(e),e.i(o))}function lt(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function He(e,o,t){const{fragment:s,after_update:i}=e.$$;s&&s.m(o,t),bt(()=>{const n=e.$$.on_mount.map(Rt).filter(Ot);e.$$.on_destroy?e.$$.on_destroy.push(...n):$(n),e.$$.on_mount=[]}),i.forEach(bt)}function Le(e,o){const t=e.$$;t.fragment!==null&&(ve(t.after_update),$(t.on_destroy),t.fragment&&t.fragment.d(o),t.on_destroy=t.fragment=null,t.ctx=[])}function Te(e,o){e.$$.dirty[0]===-1&&(X.push(e),me(),e.$$.dirty.fill(0)),e.$$.dirty[o/31|0]|=1<<o%31}function Se(e,o,t,s,i,n,r=null,l=[-1]){const d=st;tt(e);const u=e.$$={fragment:null,ctx:[],props:n,update:et,not_equal:i,bound:Tt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(o.context||(d?d.$$.context:[])),callbacks:Tt(),dirty:l,skip_bound:!1,root:o.target||d.$$.root};r&&r(u.root);let b=!1;if(u.ctx=t?t(e,o.props||{},(a,f,...p)=>{const v=p.length?p[0]:f;return u.ctx&&i(u.ctx[a],u.ctx[a]=v)&&(!u.skip_bound&&u.bound[a]&&u.bound[a](v),b&&Te(e,a)),f}):[],u.update(),b=!0,$(u.before_update),u.fragment=s?s(u.ctx):!1,o.target){if(o.hydrate){const a=fe(o.target);u.fragment&&u.fragment.l(a),a.forEach(O)}else u.fragment&&u.fragment.c();o.intro&&ke(e.$$.fragment),He(e,o.target,o.anchor),zt()}tt(d)}class Ce{constructor(){B(this,"$$");B(this,"$$set")}$destroy(){Le(this,1),this.$destroy=et}$on(o,t){if(!Ot(t))return et;const s=this.$$.callbacks[o]||(this.$$.callbacks[o]=[]);return s.push(t),()=>{const i=s.indexOf(t);i!==-1&&s.splice(i,1)}}$set(o){this.$$set&&!he(o)&&(this.$$.skip_bound=!0,this.$$set(o),this.$$.skip_bound=!1)}}const Pe="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Pe);function Pt(e,o,t){const s=e.slice();return s[54]=o[t],s}function It(e,o,t){const s=e.slice();return s[54]=o[t],s}function At(e){let o,t,s,i,n,r,l,d,u,b,a=e[8]&&Dt(e);function f(m,w){return m[8]?Ae:Ie}let p=f(e),v=p(e);return{c(){o=A("div"),a&&a.c(),t=U(),s=A("div"),i=A("button"),i.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" class="svelte-k3y442"><path fill="currentColor" d="M13,20H11V8L5.5,13.5L4.08,12.08L12,4.08L19.92,12.08L18.5,13.5L13,8V20Z"></path></svg>',n=U(),r=A("button"),r.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" class="svelte-k3y442"><path fill="currentColor" d="M13,4H11V16L5.5,10.5L4.08,12L12,20L19.92,12L18.5,10.5L13,16V4Z"></path></svg>',l=U(),v.c(),h(i,"class","scroll-btn svelte-k3y442"),h(i,"title","Scroll to Top"),h(i,"aria-label","Scroll to Top"),h(r,"class","scroll-btn svelte-k3y442"),h(r,"title","Scroll to Bottom"),h(r,"aria-label","Scroll to Bottom"),h(s,"class","scroll-toolbar svelte-k3y442"),h(o,"class",d="floating-toc "+(e[0]?"pinned "+e[1]:e[8]?"expanded "+e[1]:"collapsed "+e[1])+" svelte-k3y442"),h(o,"style",e[5]),h(o,"role","region"),h(o,"aria-label","Floating Table of Contents")},m(m,w){N(m,o,w),a&&a.m(o,null),T(o,t),T(o,s),T(s,i),T(s,n),T(s,r),T(o,l),v.m(o,null),e[32](o),u||(b=[V(i,"click",e[10]),V(r,"click",e[11]),V(o,"mouseenter",e[16]),V(o,"mouseleave",e[17])],u=!0)},p(m,w){m[8]?a?a.p(m,w):(a=Dt(m),a.c(),a.m(o,t)):a&&(a.d(1),a=null),p===(p=f(m))&&v?v.p(m,w):(v.d(1),v=p(m),v&&(v.c(),v.m(o,null))),w[0]&259&&d!==(d="floating-toc "+(m[0]?"pinned "+m[1]:m[8]?"expanded "+m[1]:"collapsed "+m[1])+" svelte-k3y442")&&h(o,"class",d),w[0]&32&&h(o,"style",m[5])},d(m){m&&O(o),a&&a.d(),v.d(),e[32](null),u=!1,$(b)}}}function Dt(e){let o,t,s;return{c(){o=A("div"),h(o,"class","resize-handle svelte-k3y442"),h(o,"role","separator"),h(o,"aria-label","Resize TOC"),h(o,"tabindex","0"),z(o,"left",e[1]==="right"),z(o,"right",e[1]==="left")},m(i,n){N(i,o,n),t||(s=V(o,"mousedown",ot(e[9])),t=!0)},p(i,n){n[0]&2&&z(o,"left",i[1]==="right"),n[0]&2&&z(o,"right",i[1]==="left")},d(i){i&&O(o),t=!1,s()}}}function Ie(e){let o,t,s=lt(e[2]),i=[];for(let n=0;n<s.length;n+=1)i[n]=Et(Pt(e,s,n));return{c(){o=A("div"),t=A("div");for(let n=0;n<i.length;n+=1)i[n].c();h(t,"class","strip-content svelte-k3y442"),h(o,"class","collapsed-strip svelte-k3y442"),z(o,"right",e[1]==="right")},m(n,r){N(n,o,r),T(o,t);for(let l=0;l<i.length;l+=1)i[l]&&i[l].m(t,null)},p(n,r){if(r[0]&262276){s=lt(n[2]);let l;for(l=0;l<s.length;l+=1){const d=Pt(n,s,l);i[l]?i[l].p(d,r):(i[l]=Et(d),i[l].c(),i[l].m(t,null))}for(;l<i.length;l+=1)i[l].d(1);i.length=s.length}r[0]&2&&z(o,"right",n[1]==="right")},d(n){n&&O(o),Mt(i,n)}}}function Ae(e){let o,t,s,i,n,r,l,d,u,b,a,f,p,v,m;function w(k,D){return k[0]?Ee:De}let R=w(e),S=R(e),E=lt(e[2]),P=[];for(let k=0;k<E.length;k+=1)P[k]=Vt(It(e,E,k));return{c(){o=A("div"),t=A("div"),s=A("div"),i=A("button"),S.c(),r=U(),l=A("button"),l.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" class="svelte-k3y442"><path fill="currentColor" d="M6.5,10L2,14.5L6.5,19V16H11V13H6.5V10M17.5,10V13H13V16H17.5V19L22,14.5L17.5,10Z"></path></svg>',d=U(),u=A("button"),u.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" class="svelte-k3y442"><path fill="currentColor" d="M19,13H5V11H19V13Z"></path></svg>',b=U(),a=A("button"),a.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" class="svelte-k3y442"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"></path></svg>',f=U(),p=A("div");for(let k=0;k<P.length;k+=1)P[k].c();h(i,"class","action-btn svelte-k3y442"),h(i,"title",n=e[0]?"Unpin (Collapse)":"Pin (Push Content)"),h(i,"aria-label","Toggle Pin"),h(l,"class","action-btn svelte-k3y442"),h(l,"title","Switch Side"),h(l,"aria-label","Switch Dock Side"),h(u,"class","action-btn svelte-k3y442"),h(u,"title","Collapse All"),h(u,"aria-label","Collapse All"),h(a,"class","action-btn svelte-k3y442"),h(a,"title","Expand All"),h(a,"aria-label","Expand All"),h(s,"class","header-actions svelte-k3y442"),h(t,"class","toc-header svelte-k3y442"),h(p,"class","toc-content svelte-k3y442"),h(o,"class","toc-panel svelte-k3y442")},m(k,D){N(k,o,D),T(o,t),T(t,s),T(s,i),S.m(i,null),T(s,r),T(s,l),T(s,d),T(s,u),T(s,b),T(s,a),T(o,f),T(o,p);for(let C=0;C<P.length;C+=1)P[C]&&P[C].m(p,null);v||(m=[V(i,"click",e[14]),V(l,"click",e[15]),V(u,"click",e[12]),V(a,"click",e[13])],v=!0)},p(k,D){if(R!==(R=w(k))&&(S.d(1),S=R(k),S&&(S.c(),S.m(i,null))),D[0]&1&&n!==(n=k[0]?"Unpin (Collapse)":"Pin (Push Content)")&&h(i,"title",n),D[0]&262340){E=lt(k[2]);let C;for(C=0;C<E.length;C+=1){const K=It(k,E,C);P[C]?P[C].p(K,D):(P[C]=Vt(K),P[C].c(),P[C].m(p,null))}for(;C<P.length;C+=1)P[C].d(1);P.length=E.length}},d(k){k&&O(o),S.d(),Mt(P,k),v=!1,$(m)}}}function Et(e){let o,t,s,i,n;function r(){return e[30](e[54])}function l(...d){return e[31](e[54],...d)}return{c(){o=A("div"),h(o,"class","strip-item svelte-k3y442"),h(o,"data-id",t=e[54].id),St(o,"width",100-(e[54].depth-1)*10+"%"),h(o,"title",s=e[54].content),h(o,"role","button"),h(o,"tabindex","0"),z(o,"active",e[54].id===e[7])},m(d,u){N(d,o,u),i||(n=[V(o,"click",ot(r)),V(o,"keydown",ot(l))],i=!0)},p(d,u){e=d,u[0]&4&&t!==(t=e[54].id)&&h(o,"data-id",t),u[0]&4&&St(o,"width",100-(e[54].depth-1)*10+"%"),u[0]&4&&s!==(s=e[54].content)&&h(o,"title",s),u[0]&132&&z(o,"active",e[54].id===e[7])},d(d){d&&O(o),i=!1,$(n)}}}function De(e){let o,t;return{c(){o=rt("svg"),t=rt("path"),h(t,"fill","currentColor"),h(t,"d","M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12M8.8,14L10,12.8V4H14V12.8L15.2,14H8.8Z"),h(o,"viewBox","0 0 24 24"),h(o,"width","14"),h(o,"height","14"),h(o,"class","svelte-k3y442")},m(s,i){N(s,o,i),T(o,t)},d(s){s&&O(o)}}}function Ee(e){let o,t;return{c(){o=rt("svg"),t=rt("path"),h(t,"fill","currentColor"),h(t,"d","M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z"),h(o,"viewBox","0 0 24 24"),h(o,"width","14"),h(o,"height","14"),h(o,"class","svelte-k3y442")},m(s,i){N(s,o,i),T(o,t)},d(s){s&&O(o)}}}function Ft(e){let o,t,s=e[54].content+"",i,n,r,l,d,u,b,a,f=e[54].subType&&qt(e);function p(){return e[28](e[54])}function v(...m){return e[29](e[54],...m)}return{c(){o=A("div"),t=A("div"),i=ct(s),n=U(),f&&f.c(),r=U(),h(t,"class","toc-text svelte-k3y442"),h(o,"class",l="toc-item level-"+e[54].depth+" svelte-k3y442"),h(o,"data-id",d=e[54].id),h(o,"title",u=e[54].content),h(o,"role","button"),h(o,"tabindex","0"),z(o,"active",e[54].id===e[7])},m(m,w){N(m,o,w),T(o,t),T(t,i),T(o,n),f&&f.m(o,null),T(o,r),b||(a=[V(o,"click",ot(p)),V(o,"keydown",ot(v))],b=!0)},p(m,w){e=m,w[0]&4&&s!==(s=e[54].content+"")&&Bt(i,s),e[54].subType?f?f.p(e,w):(f=qt(e),f.c(),f.m(o,r)):f&&(f.d(1),f=null),w[0]&4&&l!==(l="toc-item level-"+e[54].depth+" svelte-k3y442")&&h(o,"class",l),w[0]&4&&d!==(d=e[54].id)&&h(o,"data-id",d),w[0]&4&&u!==(u=e[54].content)&&h(o,"title",u),w[0]&132&&z(o,"active",e[54].id===e[7])},d(m){m&&O(o),f&&f.d(),b=!1,$(a)}}}function qt(e){let o,t=e[54].subType.toUpperCase()+"",s;return{c(){o=A("div"),s=ct(t),h(o,"class","toc-badge svelte-k3y442")},m(i,n){N(i,o,n),T(o,s)},p(i,n){n[0]&4&&t!==(t=i[54].subType.toUpperCase()+"")&&Bt(s,t)},d(i){i&&O(o)}}}function Vt(e){let o,t=e[54].depth<=e[6]&&Ft(e);return{c(){t&&t.c(),o=Nt()},m(s,i){t&&t.m(s,i),N(s,o,i)},p(s,i){s[54].depth<=s[6]?t?t.p(s,i):(t=Ft(s),t.c(),t.m(o.parentNode,o)):t&&(t.d(1),t=null)},d(s){s&&O(o),t&&t.d(s)}}}function Fe(e){let o,t=e[3]&&e[2].length>0&&At(e);return{c(){t&&t.c(),o=Nt()},m(s,i){t&&t.m(s,i),N(s,o,i)},p(s,i){s[3]&&s[2].length>0?t?t.p(s,i):(t=At(s),t.c(),t.m(o.parentNode,o)):t&&(t.d(1),t=null)},i:et,o:et,d(s){s&&O(o),t&&t.d(s)}}}function qe(e,o,t){let s,{plugin:i}=o,{targetElement:n}=o,r=[],l=!0;const d=()=>{t(3,l=!l)},u=c=>{t(3,l=c)};let b="",a,f=!1,p="right",v=!1,m="",w=null,R=!1,S=250,E=!1,P=0,k=0;const D=()=>{if(!n||!document.contains(n))return;const c=n.querySelector(".protyle-content");if(!c)return;const _=n.querySelector(".protyle-wysiwyg"),g=c.getBoundingClientRect(),H=30;let I=g.top+H,y=g.height-H*2,L=0;const q=6;let F=!1;if(s&&_){const Ht=_.getBoundingClientRect(),re=parseFloat(c.style.paddingLeft)||0,le=parseFloat(c.style.paddingRight)||0,Lt=0;if(p==="left"){const x=Ht.left-re/2,ht=x-S-Lt,ft=g.left+q;L=Math.max(ft,ht),L+S>x?F=!0:F=!1}else{const x=Ht.right+le/2,ht=x+Lt,ft=g.right-S-q;L=Math.min(ft,ht),L<x?F=!0:F=!1}}else p==="left"?L=g.left+q:L=g.right-(s?S:32)-q,F=!1;const M=s?`width: ${S}px;`:"";t(5,m=`top: ${I}px; left: ${L}px; height: ${y}px; ${M}`),f&&F?C(n,S):C(n,0)},C=(c,_)=>{const g=c.querySelector(".protyle-content");g&&(_>0?(p==="left"?(g.style.paddingLeft=`${_}px`,g.style.paddingRight=""):(g.style.paddingRight=`${_}px`,g.style.paddingLeft=""),R=!0):R&&(g.style.paddingLeft="",g.style.paddingRight="",R=!1))},K=c=>{t(27,E=!0),P=c.clientX,k=S,document.body.style.cursor="col-resize",document.body.style.userSelect="none",window.addEventListener("mousemove",W),window.addEventListener("mouseup",_t)},W=c=>{if(!E)return;const _=c.clientX-P;let g=k+(p==="left"?_:-_);g<150&&(g=150),g>600&&(g=600),t(26,S=g),D()},_t=()=>{t(27,E=!1),document.body.style.cursor="",document.body.style.userSelect="",window.removeEventListener("mousemove",W),window.removeEventListener("mouseup",_t),at()};ge(async()=>{const c=await i.loadData("config.json");c&&(t(0,f=c.isPinned??!1),t(1,p=c.dockSide??"right"),t(26,S=c.tocWidth??250)),window.addEventListener("resize",D),Q(),D()}),pe(()=>{if(window.removeEventListener("resize",D),nt(),w&&w.disconnect(),n&&R){const c=n.querySelector(".protyle-content");c&&(c.style.paddingLeft="",c.style.paddingRight="")}j&&j.removeEventListener("scroll",Q)});let it=6;const Ut=()=>{if(n){const c=n.querySelector(".protyle-content");c&&(c.scrollTop=0)}},$t=()=>{if(n){const c=n.querySelector(".protyle-content");c&&(c.scrollTop=c.scrollHeight)}},Kt=()=>{if(r.length>0){const c=r.filter(H=>H.subType&&/^h[1-6]$/i.test(H.subType)),g=(c.length>0?c:r).reduce((H,I)=>I.depth<H?I.depth:H,100);t(6,it=g)}else t(6,it=1)},jt=()=>{t(6,it=6)},at=()=>{i.saveData("config.json",{isPinned:f,dockSide:p,tocWidth:S})},Zt=()=>{t(0,f=!f),at()},Xt=()=>{t(1,p=p==="right"?"left":"right"),at()},Gt=()=>{f||(t(24,v=!0),Yt())},Wt=()=>{f||(t(24,v=!1),nt())},Yt=()=>{window.addEventListener("mousemove",vt)},nt=()=>{window.removeEventListener("mousemove",vt)},vt=c=>{if(f||!v||!a){nt();return}const _=a.getBoundingClientRect(),g=30;(c.clientX<_.left-g||c.clientX>_.right+g||c.clientY<_.top-g||c.clientY>_.bottom+g)&&(t(24,v=!1),nt())},dt=document.createElement("div"),wt=c=>c?(dt.innerHTML=c,dt.textContent||dt.innerText||""):"",kt=()=>n?!!(n.classList.contains("history__text")||n.closest(".history__text")||n.closest(".history__panel, .history")||n.closest(".b3-dialog--open[data-key='dialog-history'], .b3-dialog--open[data-key='dialog-historydoc']")):!1,Jt=(c,_)=>{const g=c.tagName?c.tagName.toLowerCase():"";if(/^h[1-6]$/.test(g))return parseInt(g.slice(1),10);const I=(c.getAttribute("data-subtype")||c.getAttribute("data-subType")||c.getAttribute("data-type")||"").match(/h([1-6])/i);if(I)return parseInt(I[1],10);const y=c.getAttribute("data-level")||c.getAttribute("aria-level")||"",L=parseInt(y,10);return Number.isFinite(L)?L:_},Qt=c=>{const _=c.querySelector(".protyle-content")||c,g=Array.from(_.querySelectorAll('[data-type="NodeHeading"], h1, h2, h3, h4, h5, h6')),H=[];let I=0;return g.forEach(y=>{if(y.tagName&&/^h[1-6]$/i.test(y.tagName)){const M=y.closest('[data-type="NodeHeading"]');if(M&&M!==y)return}const L=y.getAttribute("data-node-id")||y.getAttribute("data-id")||y.getAttribute("data-oid")||`__toc_dom_${I++}`,q=Jt(y,1),F=wt(y.innerHTML||y.textContent||"");H.push({id:L,content:F||"Untitled",depth:q||1,subType:y.getAttribute("data-subtype")||y.getAttribute("data-subType")||(y.tagName?y.tagName.toLowerCase():void 0),element:y})}),H},xt=async(c,_)=>{c&&(b=c);try{if(kt()&&n){const I=Qt(n);t(2,r=[]),await new Promise(y=>setTimeout(y,0)),t(2,r=I);return}if(!c)return;const g=await fetch("/api/outline/getDocOutline",{method:"POST",body:JSON.stringify({id:c}),headers:{"Content-Type":"application/json"}});if(!g.ok)throw new Error(`API request failed with status: ${g.status}`);const H=await g.json();H.code===0?(t(2,r=[]),await new Promise(I=>setTimeout(I,0)),t(2,r=te(H.data||[]))):console.warn(`Failed to get outline: ${H.message||"Unknown error"}`)}catch(g){console.error("Failed to update headings:",g)}},te=c=>{const _=[],g=(H,I)=>{H&&H.forEach(y=>{let L=y.content||y.name||"Untitled",q=wt(L);const F=y.children||y.blocks||[];let M=y.depth;y.subType&&y.subType.startsWith("h")?M=parseInt(y.subType.substring(1)):y.subtype&&y.subtype.startsWith("h")&&(M=parseInt(y.subtype.substring(1))),_.push({id:y.id,content:q,depth:M||I,subType:y.subType||y.subtype}),g(F,(M||I)+1)})};return g(c,1),_},Y=c=>{if(c.id===b){if(n){const g=n.querySelector(".protyle-content");g&&g.scrollTo({top:0,behavior:"smooth"})}return}document.querySelectorAll(".protyle-wysiwyg--hl").forEach(g=>{g.classList.remove("protyle-wysiwyg--hl")});const _=window.getSelection();_&&_.rangeCount>0&&_.removeAllRanges(),setTimeout(()=>{let g=null;c.element&&document.contains(c.element)&&(g=c.element);const I=g?[]:(n||document).querySelectorAll(`[data-node-id="${c.id}"]`);for(const y of Array.from(I))if(!(y.closest(".protyle-embed")||y.offsetParent===null||y.offsetWidth===0||y.offsetHeight===0))if(y.getAttribute("data-type")==="NodeHeading"){g=y;break}else y.hasAttribute("data-node-id")&&(g=y);if(g){const y=g.closest('[data-type="NodeHeading"]')||g;y.closest(".protyle-content")&&(y.scrollIntoView({behavior:"smooth",block:"start"}),y.hasAttribute("data-node-id")&&y.getAttribute("data-type")==="NodeHeading"&&(y.classList.add("protyle-wysiwyg--hl"),setTimeout(()=>{y.classList.remove("protyle-wysiwyg--hl")},1024)))}},100)};let J="",ut=null;const Q=()=>{ut||r.length!==0&&(ut=requestAnimationFrame(()=>{if(ut=null,!n)return;const c=n.querySelector(".protyle-content");if(!c)return;const _=kt(),g=_?r.map(L=>L.element).filter(L=>!!L):Array.from(c.querySelectorAll('[data-type="NodeHeading"]'));let H="";const y=c.getBoundingClientRect().top+100;for(const L of g)if(L.getBoundingClientRect().top<=y)if(_){const F=r.find(M=>M.element===L);H=(F==null?void 0:F.id)||""}else H=L.getAttribute("data-node-id")||"";else break;if(H&&H!==J){t(7,J=H);const L=a==null?void 0:a.querySelector(`.toc-item[data-id="${J}"]`);L&&L.scrollIntoView({behavior:"smooth",block:"nearest"});const q=a==null?void 0:a.querySelector(`.strip-item[data-id="${J}"]`);q&&q.scrollIntoView({behavior:"smooth",block:"nearest"})}}))};let j=null;ye(()=>{if(n){const c=n.querySelector(".protyle-content");c!==j&&(j&&j.removeEventListener("scroll",Q),c&&(c.addEventListener("scroll",Q,{passive:!0}),j=c))}});const ee=c=>Y(c),oe=(c,_)=>_.key==="Enter"&&Y(c),se=c=>Y(c),ie=(c,_)=>_.key==="Enter"&&Y(c);function ne(c){yt[c?"unshift":"push"](()=>{a=c,t(4,a)})}return e.$$set=c=>{"plugin"in c&&t(19,i=c.plugin),"targetElement"in c&&t(20,n=c.targetElement)},e.$$.update=()=>{if(e.$$.dirty[0]&150994945&&t(8,s=f||v||E),e.$$.dirty[0]&118489091&&(n||p||f||v||S)&&(D(),w&&w.disconnect(),n&&(t(25,w=new ResizeObserver(()=>{D()})),w.observe(n))),e.$$.dirty[0]&1048576&&n){const c=n.querySelector(".protyle-content");c&&c.addEventListener("scroll",Q,{passive:!0})}},[f,p,r,l,a,m,it,J,s,K,Ut,$t,Kt,jt,Zt,Xt,Gt,Wt,Y,i,n,d,u,xt,v,w,S,E,ee,oe,se,ie,ne]}class Ve extends Ce{constructor(o){super(),Se(this,o,qe,Fe,ue,{plugin:19,targetElement:20,toggle:21,setVisible:22,updateHeadings:23},null,[-1,-1])}get toggle(){return this.$$.ctx[21]}get setVisible(){return this.$$.ctx[22]}get updateHeadings(){return this.$$.ctx[23]}}class Re extends de.Plugin{constructor(){super(...arguments);B(this,"tocInstances",new Map);B(this,"tocDocIds",new Map);B(this,"tocVisible",!0);B(this,"observer");B(this,"switchProtyleHandler");B(this,"checkProtylesDebounceTimer");B(this,"searchPreviewCheckInterval")}async onload(){console.log("Floating TOC loaded"),this.switchProtyleHandler=this.onSwitchProtyle.bind(this),this.addTopBar({icon:"iconAlignLeft",title:this.i18n.displayName||"Floating TOC",position:"right",callback:()=>{this.toggleToc()}})}onLayoutReady(){this.eventBus.on("switch-protyle",this.switchProtyleHandler),this.eventBus.on("update-block",this.handleBlockUpdate.bind(this)),this.eventBus.on("loaded-protyle",this.onLoadedProtyle.bind(this)),this.monitorProtyles(),this.checkProtyles(),this.startSearchPreviewCheck()}onunload(){this.observer&&(this.observer.disconnect(),this.observer=void 0),this.eventBus.off("switch-protyle",this.switchProtyleHandler),this.eventBus.off("update-block",this.handleBlockUpdate.bind(this)),this.eventBus.off("loaded-protyle",this.onLoadedProtyle.bind(this)),this.checkProtylesDebounceTimer&&(clearTimeout(this.checkProtylesDebounceTimer),this.checkProtylesDebounceTimer=void 0),this.searchPreviewCheckInterval&&(clearInterval(this.searchPreviewCheckInterval),this.searchPreviewCheckInterval=void 0),this.tocInstances.forEach(t=>{t.$destroy()}),this.tocInstances.clear(),this.tocDocIds.clear()}onLoadedProtyle(t){var i;const s=t.detail.protyle;if(s&&s.element){console.log("Floating TOC: onLoadedProtyle - protyle.block.rootID:",(i=s.block)==null?void 0:i.rootID,"protyle.element:",s.element);const n=s.element.closest(".search__preview, .search__doc")!==null;console.log("Floating TOC: onLoadedProtyle - isSearchPreview:",n);let r=this.tocInstances.get(s.element),l=this.getDocIdFromProtyleElement(s.element,s);!l&&this.isHistoryHost(s.element)&&(l="history");const d=this.tocDocIds.get(s.element),u=l?this.getDocKeyForHost(s.element,l):"",b=!!r;r||l&&(console.log("Floating TOC: onLoadedProtyle - Creating new TOC instance"),this.createToc(s.element,l),r=this.tocInstances.get(s.element)),r&&l&&b&&d!==u&&(console.log("Floating TOC: onLoadedProtyle - Updating TOC with rootID:",l),this.updateTocForHost(s.element,l,s,!0),n&&setTimeout(()=>{const a=this.getDocIdFromProtyleElement(s.element,s);a&&(console.log("Floating TOC: onLoadedProtyle - Search preview delayed update with rootID:",a),this.updateTocForHost(s.element,a,s,!0))},200))}}startSearchPreviewCheck(){this.searchPreviewCheckInterval=window.setInterval(()=>{this.checkSearchPreviewTOC(),this.checkHistoryPreviewTOC()},800)}checkSearchPreviewTOC(){this.getSearchPreviewHosts().forEach(s=>{const i=this.getDocIdFromProtyleElement(s);i&&this.updateTocForHost(s,i,s.protyle)})}checkHistoryPreviewTOC(){this.getHistoryPreviewHosts().forEach(s=>{let i=this.getDocIdFromProtyleElement(s);!i&&this.isHistoryHost(s)&&(i="history"),i&&this.updateTocForHost(s,i,s.protyle)})}handleSearchResultChange(){console.log("Floating TOC: handleSearchResultChange called");const t=this.getSearchPreviewHosts();t.length===0&&console.warn("Floating TOC: No search preview hosts found"),t.forEach(s=>{const i=this.getDocIdFromProtyleElement(s);if(!i){console.warn("Floating TOC: Could not get rootId for search result");return}console.log("Floating TOC: Updating search TOC with rootId:",i),this.updateTocForHost(s,i,s.protyle),setTimeout(()=>{const n=this.getDocIdFromProtyleElement(s);n&&(console.log("Floating TOC: Delayed TOC update with rootId:",n),this.updateTocForHost(s,n,s.protyle))},200)})}handleHistoryResultChange(){const t=this.getHistoryPreviewHosts();t.length!==0&&t.forEach(s=>{let i=this.getDocIdFromProtyleElement(s);!i&&this.isHistoryHost(s)&&(i="history"),i&&this.updateTocForHost(s,i,s.protyle)})}monitorProtyles(){const t=document.body;this.observer=new MutationObserver(l=>{let d=!1,u=!1,b=!1;for(const a of l)if(a.type==="childList"){for(const f of a.addedNodes)f instanceof HTMLElement&&((f.classList.contains("protyle")||f.querySelector(".protyle")||f.classList.contains("dialog-globalsearch")||f.classList.contains("b3-dialog"))&&(d=!0),f.classList.contains("search__list")&&(this.addSearchListItemListeners(f),u=!0),f.classList.contains("b3-list-item")&&f.closest(".search__list")&&(u=!0),(f.classList.contains("history__panel")||f.classList.contains("history__side")||f.classList.contains("history__list")||f.classList.contains("history__text")||f.querySelector(".history__side")||f.querySelector(".history__text"))&&(d=!0,b=!0),f.classList.contains("b3-list-item")&&f.closest(".history__side, .history__list, .history__repo")&&(b=!0));for(const f of a.removedNodes)f instanceof HTMLElement&&(f.classList.contains("protyle")||f.querySelector(".protyle")||f.classList.contains("dialog-globalsearch")||f.classList.contains("b3-dialog"))&&(d=!0)}else a.type==="attributes"&&a.target instanceof HTMLElement&&(a.target.classList.contains("b3-list-item")&&a.attributeName==="class"&&a.target.closest(".search__list")&&(u=!0,d=!0),(a.target.classList.contains("protyle-breadcrumb__item")||a.target.classList.contains("protyle-breadcrumb"))&&(u=!0,d=!0),(a.target.classList.contains("protyle-content")||a.target.classList.contains("search__preview")||a.target.classList.contains("search__doc"))&&(u=!0,d=!0),a.target.classList.contains("b3-list-item")&&a.attributeName==="class"&&a.target.closest(".history__side, .history__list, .history__repo")&&(b=!0,d=!0),(a.target.classList.contains("history__side")||a.target.classList.contains("history__list")||a.target.classList.contains("history__text")||a.target.classList.contains("history__panel"))&&(b=!0,d=!0),a.target.classList.contains("protyle")&&a.attributeName==="data-loading"&&(u=!0,d=!0));d&&this.debouncedCheckProtyles(),u&&(this.handleSearchResultChange(),setTimeout(()=>{this.handleSearchResultChange()},300),setTimeout(()=>{this.handleSearchResultChange()},600)),b&&(this.handleHistoryResultChange(),setTimeout(()=>{this.handleHistoryResultChange()},300))}),this.observer.observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-loading","data-node-id","data-root-id"]}),document.querySelectorAll(".search__list").forEach(l=>{this.addSearchListItemListeners(l)}),document.addEventListener("keydown",l=>{document.querySelector('.b3-dialog--open[data-key="dialog-globalsearch"]')&&["ArrowUp","ArrowDown","PageUp","PageDown"].includes(l.key)&&(setTimeout(()=>{this.handleSearchResultChange()},100),setTimeout(()=>{this.handleSearchResultChange()},400))}),document.querySelectorAll(".search__preview").forEach(l=>{l.addEventListener("click",()=>{this.handleSearchResultChange(),setTimeout(()=>{this.handleSearchResultChange()},200)})}),document.querySelectorAll(".search__doc").forEach(l=>{l.addEventListener("click",()=>{this.handleSearchResultChange(),setTimeout(()=>{this.handleSearchResultChange()},200)})}),document.querySelectorAll(".history__side, .history__list, .history__repo").forEach(l=>{l.addEventListener("click",()=>{this.handleHistoryResultChange(),setTimeout(()=>{this.handleHistoryResultChange()},200)})})}addSearchListItemListeners(t){t.removeEventListener("click",this.handleSearchListItemClick.bind(this)),t.addEventListener("click",this.handleSearchListItemClick.bind(this))}handleSearchListItemClick(t){t.target.closest(".b3-list-item")&&(this.handleSearchResultChange(),setTimeout(()=>{this.handleSearchResultChange()},300))}debouncedCheckProtyles(){this.checkProtylesDebounceTimer&&clearTimeout(this.checkProtylesDebounceTimer),this.checkProtylesDebounceTimer=window.setTimeout(()=>{this.checkProtyles()},100)}checkProtyles(){const t=Array.from(document.querySelectorAll(".protyle, .search__preview, .search__doc, .history__text, .history__text .protyle, [data-type='docPanel'].history__text")),s=new Set;t.forEach(n=>{if(!(n instanceof HTMLElement))return;const r=this.getTocHostElement(n);r&&s.add(r)}),Array.from(s).forEach(n=>{if(console.log("Floating TOC: checkProtyles - protyle:",n),!(n.querySelector(".protyle-content")||n.querySelector(".protyle-wysiwyg")))return;let l=this.getDocIdFromProtyleElement(n);if(!l&&this.isHistoryHost(n)&&(l="history"),!!l)if(!this.tocInstances.has(n))console.log("Floating TOC: Creating TOC for protyle:",n,"with docId:",l),this.createToc(n,l);else{const d=this.tocDocIds.get(n);this.getDocKeyForHost(n,l)!==d&&(console.log("Floating TOC: Updating TOC for protyle:",n,"with new docId:",l),this.updateTocForHost(n,l,n.protyle))}});for(const[n,r]of this.tocInstances.entries())document.contains(n)||(console.log("Floating TOC: Removing TOC for protyle:",n),r.$destroy(),this.tocInstances.delete(n),this.tocDocIds.delete(n))}createToc(t,s){const i=document.createElement("div");i.className="siyuan-floating-toc-plugin-container",t.appendChild(i);const n=new Ve({target:i,props:{plugin:this,targetElement:t}});typeof n.setVisible=="function"&&n.setVisible(this.tocVisible),n.updateHeadings(s,{element:t}),this.tocDocIds.set(t,this.getDocKeyForHost(t,s)),this.tocInstances.set(t,n)}toggleToc(){this.tocVisible=!this.tocVisible,this.tocInstances.forEach(t=>{typeof t.setVisible=="function"?t.setVisible(this.tocVisible):typeof t.toggle=="function"&&t.toggle()})}onSwitchProtyle(t){const s=t.detail.protyle;if(s&&s.element){let i=this.tocInstances.get(s.element);const n=this.getDocIdFromProtyleElement(s.element,s);i||n&&(this.createToc(s.element,n),i=this.tocInstances.get(s.element)),i&&n&&(i.updateHeadings(n,s),this.tocDocIds.set(s.element,this.getDocKeyForHost(s.element,n)))}}getTocHostElement(t){if(t.classList.contains("protyle"))return t;const s=t.querySelector(".protyle");if(s instanceof HTMLElement)return s;const i=t.querySelector("[data-type='docPanel']");return i instanceof HTMLElement&&i.querySelector(".protyle-content")?i:t.querySelector(".protyle-content")?t:null}getSearchPreviewHosts(){const t=new Set;return document.querySelectorAll("#searchPreview, .search__preview, .search__doc").forEach(i=>{if(!(i instanceof HTMLElement))return;const n=this.getTocHostElement(i);n&&t.add(n)}),Array.from(t)}getHistoryPreviewHosts(){const t=new Set;return document.querySelectorAll("#historyPreview, .history__text, .history__text.protyle, .history__text .protyle, [data-type='docPanel'].history__text, .b3-dialog--open[data-key='dialog-history'] .protyle, .b3-dialog--open[data-key='dialog-historydoc'] .protyle, .b3-dialog--open[data-key='dialog-history'] [data-type='docPanel'], .b3-dialog--open[data-key='dialog-historydoc'] [data-type='docPanel']").forEach(i=>{if(!(i instanceof HTMLElement))return;const n=this.getTocHostElement(i);n&&t.add(n)}),Array.from(t)}isHistoryHost(t){return!!(t.classList.contains("history__text")||t.closest(".history__text")||t.closest(".history__panel, .history")||t.closest(".b3-dialog--open[data-key='dialog-history'], .b3-dialog--open[data-key='dialog-historydoc']"))}getHistorySnapshotKey(t,s){var b;const i=s||"history",n=t.closest(".history__panel, .history, .b3-dialog")||document,r=n.querySelector(".history__side, .history__list, .history__repo")||n,d=r.querySelector(".b3-list-item--focus, .b3-list-item--selected, .b3-list-item--current")||r.querySelector(".b3-list-item"),u=(d==null?void 0:d.getAttribute("data-path"))||((b=d==null?void 0:d.dataset)==null?void 0:b.path);return u?`${i}|${u}`:i}getHistoryContentSignature(t){var d,u,b;const i=(t.querySelector(".protyle-content")||t).querySelectorAll('[data-type="NodeHeading"], h1, h2, h3, h4, h5, h6'),n=i.length;if(n===0)return"c0";const r=i[0],l=((d=r==null?void 0:r.getAttribute)==null?void 0:d.call(r,"data-node-id"))||((u=r==null?void 0:r.getAttribute)==null?void 0:u.call(r,"data-id"))||((b=r==null?void 0:r.getAttribute)==null?void 0:b.call(r,"data-oid"))||"";return`c${n}:${l}`}getDocKeyForHost(t,s){if(!s)return"";if(this.isHistoryHost(t)){const i=this.getHistorySnapshotKey(t,s),n=t.getAttribute("data-loading")||"",r=this.getHistoryContentSignature(t);return`${i}|${n}|${r}`}return s}getDocIdFromSearchContext(t){const s=t.closest(".b3-dialog--open[data-key='dialog-globalsearch'], .search")||document,i=s.querySelector(".search__list .b3-list-item--focus"),n=s.querySelector(".search__list .b3-list-item"),r=i||n;return r?r.getAttribute("data-root-id")||r.getAttribute("data-node-id")||r.getAttribute("data-doc-id"):null}getDocIdFromHistoryContext(t){var m,w,R,S,E,P,k,D;const s=t.closest(".history__panel, .history, .b3-dialog")||document,i=s.querySelector(".history__side, .history__list, .history__repo")||s;let r=i.querySelector(".b3-list-item--focus, .b3-list-item--selected, .b3-list-item--current")||i.querySelector(".b3-list-item");if(!r)return null;const l=r.getAttribute("data-path")||((m=r.dataset)==null?void 0:m.path),d=this.extractDocIdFromPath(l);if(d)return d;const u=r.getAttribute("data-root-id")||r.getAttribute("data-node-id")||r.getAttribute("data-doc-id")||r.getAttribute("data-id");if(u)return u;const b=((w=i.getAttribute)==null?void 0:w.call(i,"data-path"))||((R=i.dataset)==null?void 0:R.path)||((S=s.getAttribute)==null?void 0:S.call(s,"data-path"))||((E=s.dataset)==null?void 0:E.path)||((P=t.getAttribute)==null?void 0:P.call(t,"data-path"))||((k=t.dataset)==null?void 0:k.path),a=this.extractDocIdFromPath(b);if(a)return a;const f=Array.from(s.querySelectorAll("[data-path]"));for(const C of f){const K=C.getAttribute("data-path")||((D=C.dataset)==null?void 0:D.path),W=this.extractDocIdFromPath(K);if(W)return W}const p=s.querySelector(".protyle-title__input"),v=(p==null?void 0:p.getAttribute("data-node-id"))||(p==null?void 0:p.getAttribute("data-doc-id"))||(p==null?void 0:p.getAttribute("data-id"));return v||null}extractDocIdFromPath(t){if(!t)return"";const s=String(t).match(/(?:^|[\\/])(\d{14}-[a-z0-9]{7})\.(?:syx|sy)$/i);if(s)return s[1];const i=String(t).match(/\d{14}-[a-z0-9]{7}/gi);return i&&i.length>0?i[i.length-1]:""}getDocIdFromProtyleElement(t,s){const i=t.querySelector(".protyle-content"),n=t.querySelector(".protyle-wysiwyg"),r=t.querySelector('[data-type="NodeDocument"]'),l=t.querySelector(".protyle-title__input"),d=t.querySelector(".protyle-title");let u=(i==null?void 0:i.getAttribute("data-node-id"))||(i==null?void 0:i.getAttribute("data-root-id"))||(i==null?void 0:i.getAttribute("data-doc-id"))||(i==null?void 0:i.getAttribute("data-id"))||(i==null?void 0:i.getAttribute("data-oid"))||(n==null?void 0:n.getAttribute("data-node-id"))||(r==null?void 0:r.getAttribute("data-node-id"))||(r==null?void 0:r.getAttribute("data-id"))||(l==null?void 0:l.getAttribute("data-node-id"))||(l==null?void 0:l.getAttribute("data-doc-id"))||(l==null?void 0:l.getAttribute("data-id"))||(d==null?void 0:d.getAttribute("data-node-id"))||(d==null?void 0:d.getAttribute("data-doc-id"))||(d==null?void 0:d.getAttribute("data-id"))||t.getAttribute("data-node-id")||t.getAttribute("data-root-id")||t.getAttribute("data-doc-id")||t.getAttribute("data-id")||t.getAttribute("data-oid")||"";const b=s||t.protyle;if(!u&&b&&b.block&&b.block.rootID&&(u=b.block.rootID),!u){const a=t.querySelector(".protyle-breadcrumb");if(a){const f=a.querySelectorAll(".protyle-breadcrumb__item");for(const p of f){const v=p.getAttribute("data-node-id");if(v){u=v;break}}}}return u||(u=this.getDocIdFromSearchContext(t)||this.getDocIdFromHistoryContext(t)||""),u||null}updateTocForHost(t,s,i,n=!1){const r=this.getDocKeyForHost(t,s),l=this.tocDocIds.get(t);let d=this.tocInstances.get(t);d&&!n&&l===r||(d?d.updateHeadings(s,i||{element:t}):(this.createToc(t,s),d=this.tocInstances.get(t)),d&&this.tocDocIds.set(t,r||s))}handleBlockUpdate(t){const s=t.detail;if(s&&s.id){const i=document.querySelector(`[data-node-id="${s.id}"]`);if(i){const n=i.closest(".protyle");if(n&&this.tocInstances.has(n)){const r=this.tocInstances.get(n);if(r){const l=this.getDocIdFromProtyleElement(n);l&&(r.updateHeadings(l,{element:n}),this.tocDocIds.set(n,this.getDocKeyForHost(n,l)))}}}}}}module.exports=Re;
